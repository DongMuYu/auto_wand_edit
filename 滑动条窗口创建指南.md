# 滑动条窗口创建指南

## 概述

本文档讲解如何在当前项目的窗口创建流程中，创建一个带有滑动条的测试窗口。该窗口位于屏幕中央，包含一个滑动条和一个数字显示，滑动条可以改变显示的数字。

## 当前项目的窗口创建流程

### 1. 窗口创建基础结构

当前项目使用模块化的窗口管理系统，主要涉及以下几个关键步骤：

#### 1.1 创建窗口对象

使用 `make_window()` 函数创建窗口对象：

```lua
local test_window = make_window("test_window", screen_x, screen_y, width, height, show, title)
```

参数说明：
- `"test_window"` - 窗口的唯一标识符（用于保存位置和大小设置）
- `screen_x`, `screen_y` - 窗口的初始位置坐标
- `width`, `height` - 窗口的初始尺寸
- `show` - 窗口初始是否显示（true/false）
- `title` - 窗口标题栏显示的文本

窗口对象会自动保存位置、大小和显示状态到模组设置中。

#### 1.2 定义窗口内容函数

为窗口对象定义 `func` 属性，该函数负责绘制窗口内的所有内容：

```lua
test_window.func = function(window)
    -- 在这里绘制窗口内容
    -- 使用 window.x, window.y 获取窗口位置
    -- 使用 window.width, window.height 获取窗口尺寸
end
```

#### 1.3 集成到窗口渲染系统

窗口对象会被自动添加到全局窗口列表中，通过 `draw_windows()` 函数统一渲染。

### 2. 窗口渲染流程

窗口渲染遵循以下步骤：

1. **初始化GUI** - 调用 `initialize_gui()` 开始GUI帧
2. **计算坐标** - 调用 `calculate_camera_and_mouse_coords()` 获取屏幕和鼠标坐标
3. **绘制窗口** - 调用 `draw_windows()` 渲染所有窗口
   - 对每个窗口调用 `start_window()` 开始渲染
   - 执行窗口的 `func` 函数绘制内容
   - 调用 `end_window()` 结束渲染

### 3. 坐标系统

窗口内容绘制使用相对坐标系统：

- 窗口内部的原点 `(0, 0)` 位于窗口内容区域的左上角
- 窗口标题栏高度为 9 像素（`drag_bar_height`）
- 内容区域从 `y = drag_bar_height - 2` 开始
- 使用 `x` 和 `y` 变量跟踪当前绘制位置，逐步向下递增

## 创建滑动条窗口的方法

### 1. 窗口设计

滑动条测试窗口的设计要求：

- **位置**：屏幕中央
- **尺寸**：足够容纳滑动条和数字显示
- **内容**：
  - 一个滑动条（水平方向）
  - 一个数字显示（显示滑动条的当前值）
  - 可选：标题和说明文本

### 2. 滑动条创建方法

使用 `GuiSlider()` 函数创建滑动条：

```lua
GuiSlider(gui, id, x, y, text, value, value_min, value_max, value_default, value_display_multiplier, value_formatting_string, width)
```

参数说明：
- `gui` - GUI对象实例
- `id` - 滑动条的唯一标识符（使用 `get_id()` 生成）
- `x`, `y` - 滑动条的位置坐标（相对于窗口内容区域）
- `text` - 滑动条旁边的文本标签（可以为空字符串）
- `value` - 滑动条的当前值
- `value_min` - 滑动条的最小值
- `value_max` - 滑动条的最大值
- `value_default` - 滑动条的默认值
- `value_display_multiplier` - 显示值的乘数（用于调整显示精度）
- `value_formatting_string` - 值的格式化字符串（例如 " " 表示无格式化）
- `width` - 滑动条的宽度（像素）

### 3. 值存储和管理

滑动条的值需要存储在模块的状态对象中，以便在窗口函数中访问和更新：

- 创建一个状态表来存储滑动条的值
- 状态表应该包含滑动条的当前值、最小值、最大值等配置
- 提供获取和设置值的函数接口

### 4. 窗口内容绘制步骤

在窗口的 `func` 函数中，按照以下步骤绘制内容：

1. **初始化坐标** - 设置 `x` 和 `y` 变量为窗口内容区域的起始位置
2. **绘制标题** - 使用 `GuiText()` 显示窗口标题
3. **绘制说明文本** - 使用 `GuiText()` 显示说明信息
4. **创建滑动条** - 使用 `GuiSlider()` 创建滑动条，并获取返回的新值
5. **更新状态** - 将滑动条返回的新值保存到状态对象中
6. **显示当前值** - 使用 `GuiText()` 显示滑动条的当前值
7. **更新窗口尺寸** - 根据内容调整窗口高度（如果需要）

### 5. 嵌入到现有系统

将滑动条窗口集成到现有系统的步骤：

1. **在 gui_manager.lua 中创建窗口对象**
   - 使用 `make_window()` 创建窗口
   - 设置窗口位置为屏幕中央（使用 `gw/2 - width/2`, `gh/2 - height/2`）

2. **在 gui_manager.lua 中定义窗口函数**
   - 为窗口对象设置 `func` 属性
   - 在函数中实现滑动条和数字显示的逻辑

3. **添加窗口显示控制**
   - 可以添加一个按钮来切换窗口的显示/隐藏状态
   - 使用 `do_window_show_hide_button()` 函数创建切换按钮

4. **导出窗口对象**
   - 在 gui_manager.lua 的返回值中包含新窗口对象
   - 允许其他模块访问和控制窗口

## 实现要点

### 1. 坐标计算

- 窗口位置使用屏幕坐标（像素）
- 窗口内容使用相对坐标（相对于窗口内容区域）
- 滑动条和文本的位置需要合理布局，避免重叠

### 2. 值更新机制

- `GuiSlider()` 函数返回滑动条的新值
- 每次渲染时都会调用 `GuiSlider()`，需要将返回值保存到状态中
- 状态对象应该在模块初始化时创建，并在整个生命周期中保持

### 3. 窗口尺寸管理

- 窗口高度应该根据内容动态调整
- 使用 `window.height = new_height` 更新窗口高度
- 确保窗口高度足够容纳所有内容

### 4. 交互性

- 窗口默认是可交互的
- 滑动条自动支持鼠标拖动交互
- 不需要额外的交互处理代码

## 与现有窗口系统的兼容性

滑动条窗口完全兼容现有的窗口系统：

- 使用相同的窗口创建和管理机制
- 遵循相同的坐标系统和渲染流程
- 支持窗口拖动、调整大小、关闭等标准功能
- 自动保存窗口位置、大小和显示状态

## 扩展建议

完成基本的滑动条窗口后，可以考虑以下扩展：

1. **多个滑动条** - 在窗口中添加多个滑动条，每个控制不同的值
2. **滑动条标签** - 为每个滑动条添加描述性标签
3. **值格式化** - 使用格式化字符串美化数值显示
4. **范围控制** - 动态调整滑动条的最小值和最大值
5. **事件响应** - 在值变化时触发特定的逻辑

## 总结

创建滑动条窗口的核心步骤：

1. 使用 `make_window()` 创建窗口对象
2. 定义窗口的 `func` 函数
3. 在 `func` 中使用 `GuiSlider()` 创建滑动条
4. 管理滑动条值的状态
5. 使用 `GuiText()` 显示当前值
6. 集成到现有的窗口渲染系统中

通过遵循当前项目的窗口创建流程，可以轻松创建功能完善的滑动条窗口，并保持与现有系统的一致性。